<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Serverspec Tests - SecureDrop</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">
        <link href="../css/extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">SecureDrop</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Home</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Installation <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../installation/install/">Installation Overview</a>
                        </li>
                    
                        <li >
                            <a href="../installation/hardware/">Hardware Requirements</a>
                        </li>
                    
                        <li >
                            <a href="../installation/deployment_practices/">Deployment Practices</a>
                        </li>
                    
                        <li >
                            <a href="../installation/ubuntu_config/">Server Config</a>
                        </li>
                    
                        <li >
                            <a href="../installation/network_firewall/">Network Firewall</a>
                        </li>
                    
                        <li >
                            <a href="../installation/ossec_alerts/">OSSEC Alerts</a>
                        </li>
                    
                        <li >
                            <a href="../installation/yubikey_setup/">Yubikey Setup</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Support <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../source_user_manual/">Source User Manual</a>
                        </li>
                    
                        <li >
                            <a href="../journalist_user_manual/">Journalist User Manual</a>
                        </li>
                    
                        <li >
                            <a href="../admin_interface/">Admin User Manual</a>
                        </li>
                    
                        <li >
                            <a href="../tails_guide/">Using Tails</a>
                        </li>
                    
                        <li >
                            <a href="../google_authenticator/">Google Authenticator</a>
                        </li>
                    
                        <li >
                            <a href="">Upgrading SecureDrop</a>
                        </li>
                    
                        <li >
                            <a href="../tails_printing_guide/">Printing with Tails</a>
                        </li>
                    
                        <li >
                            <a href="../terminology/">Terminology</a>
                        </li>
                    
                        <li >
                            <a href="../threat_model/">Threat Model</a>
                        </li>
                    
                        <li >
                            <a href="../training_schedule/">Training Schedule</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contributing <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../develop/">Development Environment</a>
                        </li>
                    
                        <li class="active">
                            <a href="">Running the Tests</a>
                        </li>
                    
                        <li >
                            <a href="../apparmor_profiles/">AppArmor Profiles</a>
                        </li>
                    
                        <li >
                            <a href="../creating_deb/">Building .deb packages</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../develop/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../snap_ci/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#serverspec-tests">Serverspec tests</a></li>
        
            <li><a href="#install-directions-ubuntu">Install directions (Ubuntu)</a></li>
        
            <li><a href="#spectest-layout">Spectest layout</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="serverspec-tests">Serverspec tests</h1>
<p><a href="http://serverspec.org/">serverspec</a> tests verify the end state of the vagrant machines. 
Any changes to the Ansible configuration should have a corresponding spectest.</p>
<h2 id="install-directions-ubuntu">Install directions (Ubuntu)</h2>
<pre><code>apt-get install bundler
cd spec_tests/
bundle update
</code></pre>

<h3 id="running-the-tests">Running the tests</h3>
<pre><code>cd spec_tests/
bundle exec rake spec
</code></pre>

<p>This will run the tests against all configured hosts, specifically: 
<em> development
</em> app-staging
<em> mon-staging
</em> build</p>
<p>In order to run the tests, each VM will be created and provisioned, if necessary.
Running all VMs concurrently may cause performance problems if you have less
than 8GB of RAM. You can isolate specific machines for faster testing:</p>
<pre><code>cd spec_tests
bundle exec rake --tasks # check output for desired machine
bundle exec rake spec:development
</code></pre>

<h3 id="updating-the-tests">Updating the tests</h3>
<p>Changes to the ansible config should result in failing spectests, but
only if an existing task was modified. If you add a new task, make sure 
to add a corresponding spectest to validate that state after a new provisioning run.
Tests import variables from separate YAML files than the Ansible playbooks:</p>
<pre><code>spec_tests/spec/vars
├── development.yml
└── staging.yml
</code></pre>

<p>Any variable changes in the Ansible config should have a corresponding entry 
in these vars files. These vars are dynamically loaded for each host via the
<code>spec_helper.rb</code> file. Make sure to add your tests to relevant location 
for the host you plan to test:</p>
<pre><code>spec_tests/spec/app-staging
├── apache_spec.rb
├── apparmor_spec.rb
├── iptables_spec.rb
├── ossec_agent_spec.rb
├── securedrop_app_spec.rb
├── securedrop_app_test_spec.rb
└── tor_spec.rb
</code></pre>

<p>In the example above, to add a new test for the <code>app-staging</code> host,
add a new file to the <code>spec_tests/spec/app-staging</code> directory.</p>
<h2 id="spectest-layout">Spectest layout</h2>
<p>The serverspec tests are mostly broken up according to
machines in the Vagrantfile:</p>
<pre><code>spec_tests/spec
├── app-staging
├── build
├── common-development
├── common-staging
├── development
├── mon-staging
└── vars
</code></pre>

<p>There are a few exceptions:</p>
<ul>
<li><code>common-development</code> shares tests between <code>development</code> and <code>app-staging</code></li>
<li><code>common-staging</code> shares tests between <code>app-staging</code> and <code>mon-staging</code></li>
</ul>
<p>Ideally the serverspec tests would be broken up according to roles, mirroring
the Ansible configuration. Prior to the reorganization of the Ansible
layout, the tests are rather tightly coupled to hosts. The layout 
of spectests is therefore subject to change.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>